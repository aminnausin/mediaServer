name: Create GitHub Release

on:
  workflow_call:
    inputs:
      tag:
        description: 'Release tag'
        required: true
        type: string
      docker_tag:
        description: 'Docker tag' # latest | beta
        required: true
        type: string
      release_name:
        description: 'Release name'
        required: true
        type: string
      is_prerelease:
        description: 'Is this a pre-release?'
        required: true
        type: boolean
      changelog:
        description: 'Changelog content (optional)'
        required: false
        type: string
        default: ''
      branch:
        description: 'Branch to checkout'
        required: true
        type: string
      always_upload_artifacts:
        description: 'Always upload artifacts regardless of file changes'
        required: false
        type: boolean
        default: false

jobs:
  check-docker-changes:
    name: Check for Docker Related File Changes
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.filter.outputs.changes != '[]' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        ref: ${{ inputs.branch }}

    - name: Check for file changes
      id: filter
      uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
      with:
        filters: |
          changed:
              - 'docker/**'
              - 'docker-compose.yaml'
              - 'Dockerfile'
              - 'startDocker.*'
              - 'data/**'
              - 'README.md'

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: check-docker-changes
    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        ref: ${{ inputs.branch }}

    - name: Determine if artifacts should be uploaded
      id: should_upload
      run: |
        ALWAYS_UPLOAD="${{ inputs.always_upload_artifacts }}"
        FILES_CHANGED="${{ needs.check-docker-changes.outputs.files_changed }}"

        if [ "$ALWAYS_UPLOAD" == "true" ] || [ "$FILES_CHANGED" == "true" ]; then
          echo "UPLOAD=true" >> $GITHUB_OUTPUT
          echo "::notice::Will upload Docker artifacts"
        else
          echo "UPLOAD=false" >> $GITHUB_OUTPUT
          echo "::notice::Skipping Docker artifacts (no changes detected)"
        fi

    - name: Update .env.docker
      if: steps.should_upload.outputs.UPLOAD == 'true'
      env:
        DOCKER_TAG: ${{ inputs.docker_tag }}
      run: |
        sed -i "s/DOCKER_RELEASE=.*/DOCKER_RELEASE=$DOCKER_TAG/" docker/.env.docker

    - name: Prepare Docker setup packages
      if: steps.should_upload.outputs.UPLOAD == 'true'
      run: |
        mkdir -p data
        cp -r storage/app/public/* data

        zip -r mediaServerDockerLinux.zip ./docker/etc ./docker/.env.docker ./docker-compose.yaml ./startDocker.sh ./README.md ./data/*
        zip -r mediaServerDockerWindows.zip ./docker/etc ./docker/.env.docker ./docker-compose.yaml ./startDocker.bat ./README.md ./data/* ./add-hosts-entry.ps1

    - name: Create Release (with artifacts)
      if: steps.should_upload.outputs.UPLOAD == 'true'
      uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b
      with:
        allowUpdates: false
        draft: false
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ inputs.tag }}
        name: ${{ inputs.release_name }}
        body: ${{ inputs.changelog || format('Release {0}', inputs.tag) }}
        prerelease: ${{ inputs.is_prerelease }}
        artifacts: mediaServerDockerLinux.zip,mediaServerDockerWindows.zip
        generateReleaseNotes: true

    - name: Create Release (without artifacts)
      if: steps.should_upload.outputs.UPLOAD != 'true'
      uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b
      with:
        allowUpdates: false
        draft: false
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ inputs.tag }}
        name: ${{ inputs.release_name }}
        body: |
          ${{ inputs.changelog || format('Release {0}', inputs.tag) }}

          ---

          **Docker Setup Files**

          No Docker-related files were changed in this release. To get the Docker setup packages, download them from a [previous release with Docker changes](https://github.com/${{ github.repository }}/releases).
        prerelease: ${{ inputs.is_prerelease }}
        generateReleaseNotes: true
