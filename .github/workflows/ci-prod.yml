name: CI & Docker Release

on:
  pull_request:
    branches:
    - 'prod'
    types:
    - closed

jobs:
  run-tests:
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
    strategy:
      fail-fast: true
    uses: ./.github/workflows/tests.yml

  # ==========================
  #  Handle Prod Release Tags
  # ==========================
  release-flow:
    name: Handle Releases Tags
    runs-on: ubuntu-latest
    needs: run-tests
    permissions:
      contents: write
    strategy:
      fail-fast: true
    outputs:
      tag: ${{ steps.version.outputs.TAG }}
      previous_tag: ${{ steps.version.outputs.PREVIOUS_TAG }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        ref: prod

    - name: Ensure VERSION file exists
      run: |
        VERSION_FILE="VERSION"
        if [ ! -f "$VERSION_FILE" ]; then
            echo "0.1.0" > "$VERSION_FILE"
        fi

    - name: Fetch full git history and tags
      run: |
        git fetch --unshallow --tags || git fetch --tags

    - name: Bump version
      id: version
      run: |
        VERSION_FILE="VERSION"
        CURRENT_VERSION=$(cat $VERSION_FILE)
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

        # Prod never updates any versions on its own
        TAG="$MAJOR.$MINOR.$PATCH"

        PREVIOUS_TAG=$(git tag --list --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
        PREVIOUS_TAG=${PREVIOUS_TAG:-}

        echo "::notice::Release Tag: $TAG"
        echo "::notice::Previous Tag: $PREVIOUS_TAG"

        echo "TAG=$TAG" >> $GITHUB_OUTPUT
        echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

    - name: Create and push Git tag
      if: steps.version.outputs.TAG != ''
      env:
        TAG: ${{ steps.version.outputs.TAG }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag already exists."
            exit 0
        fi

        git tag ${{ steps.version.outputs.TAG }}
        git push origin ${{ steps.version.outputs.TAG }}

  # ==========================
  #  Generate Changelog
  # ==========================
  generate-changelog:
    name: Generate Changelog
    needs: release-flow
    uses: ./.github/workflows/generate-changelog.yml
    with:
      previous_tag: ${{ needs.release-flow.outputs.previous_tag }}
      tag: ${{ needs.release-flow.outputs.tag }}
      branch: prod
    permissions:
      contents: write

  # ==========================
  #  Publish Docker Image
  # ==========================
  build-docker:
    needs: [ release-flow ]
    uses: ./.github/workflows/release-docker.yml
    with:
      docker_tag: 'latest'
      version_tag: ${{ needs.release-flow.outputs.tag }}
      branch: prod
    permissions:
      contents: write
    secrets: inherit

  # ==========================
  #  Release Docker Setup Pkg (Always)
  # ==========================
  release:
    needs: [ build-docker, release-flow, generate-changelog ]
    uses: ./.github/workflows/release-github.yml
    permissions:
      contents: write
    secrets: inherit
    with:
      tag: ${{ needs.release-flow.outputs.tag }}
      release_name: 'Release - ${{ needs.release-flow.outputs.tag }}'
      is_prerelease: false
      changelog: ${{ needs.generate-changelog.outputs.changelog }}
      branch: prod
      docker_tag: 'latest'
      always_upload_artifacts: true

  # ==========================
  #  Bump Main to Next Version (Only on Prod)
  # ==========================
  bump-main-version:
    name: Bump Main to Next Beta Base Version
    needs: release-flow
    if: needs.release-flow.outputs.tag != '' && github.event.pull_request.head.ref == 'main' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        ref: main

    - name: Bump main version
      run: |
        VERSION_FILE="VERSION"
        CURRENT_VERSION=$(cat $VERSION_FILE)

        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

        # Always bump MINOR after prod
        MINOR=$((MINOR + 1))
        PATCH=0

        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        TAG="${NEW_VERSION}-beta.0"

        echo "$NEW_VERSION" > $VERSION_FILE

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add VERSION
        git commit -m "chore: bump main to $TAG"
        git push origin main

        git tag $TAG
        git push origin $TAG
