name: Generate Release Changelogs

# Experimental (First Time AI Generated)

on:
  workflow_call:
    inputs:
      tag:
        description: 'Release tag'
        required: true
        type: string
      previous_tag:
        description: 'Previous tag'
        required: true
        type: string
      branch:
        description: 'Branch to checkout'
        required: true
        type: string
      write_file:
        description: 'Write changelog to file'
        required: false
        default: false
        type: boolean
    outputs:
      changelog:
        description: "Generated changelog"
        value: ${{ jobs.generate-changelog.outputs.changelog }}

jobs:
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      changelog: ${{ steps.changelog.outputs.CHANGELOG }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      with:
        ref: ${{ inputs.branch }}
        fetch-depth: 0

    - name: Generate Changelog from Conventional Commits
      id: changelog
      env:
        CURRENT_TAG: ${{ inputs.tag }}
        PREVIOUS_TAG: ${{ inputs.previous_tag }}
      run: |
        CURRENT_TAG="$CURRENT_TAG"
        PREVIOUS_TAG="$PREVIOUS_TAG"

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found, generating full changelog"
          COMMIT_RANGE=""
        else
          COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
        fi

        CHANGELOG_FILE="CHANGELOG_TEMP.md"

        echo "# Release $CURRENT_TAG" > $CHANGELOG_FILE
        echo "" >> $CHANGELOG_FILE
        echo "**Date:** $(date +%Y-%m-%d)" >> $CHANGELOG_FILE
        echo "" >> $CHANGELOG_FILE

        if [ -z "$COMMIT_RANGE" ]; then
          COMMITS=$(git log --pretty=format:"%s|||%h" --no-merges)
        else
          COMMITS=$(git log --pretty=format:"%s|||%h" --no-merges $COMMIT_RANGE)
        fi

        write_section() {
          TITLE="$1"
          PATTERN="$2"

          # matches commits to the given pattern
          MATCHES=$(echo "$COMMITS" | grep -E "$PATTERN" || true)

          # if there are matches, write out with scope under the title
          if [ -n "$MATCHES" ]; then
            echo "## $TITLE" >> $CHANGELOG_FILE
            echo "" >> $CHANGELOG_FILE

            echo "$MATCHES" | while IFS='|||' read -r msg hash author; do
              # Extract scope if exists
              if echo "$msg" | grep -Eq '^[a-zA-Z_]+!?\\([^)]+\\):'; then
                scope=$(echo "$msg" | sed -nE 's/^[a-zA-Z_]+!?\(([^)]+)\).*/\1/p')
                scope="**$scope:** "
              else
                scope=""
              fi

              clean_msg=$(echo "$msg" | sed -E 's/^[a-zA-Z_]+!?(\([^)]+\))?:[[:space:]]*//')

              echo "- $scope$clean_msg (\`$hash\`)" >> $CHANGELOG_FILE
            done

            echo "" >> $CHANGELOG_FILE
          fi
        }

        # Sections
        write_section "Features" "^feat(\(.+\))?:"
        write_section "Bug Fixes" "^fix(\(.+\))?:"
        write_section "Performance" "^perf(\(.+\))?:"
        write_section "Refactors" "^refactor(\(.+\))?:"
        write_section "Documentation" "^docs(\(.+\))?:"
        write_section "Maintenance" "^chore(\(.+\))?:"

        # Breaking changes
        BREAKING=$(echo "$COMMITS" | grep -E "^[a-z_]+!|BREAKING CHANGE" || true)
        if [ -n "$BREAKING" ]; then
          echo "## ðŸ’¥ Breaking Changes" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE

          echo "$BREAKING" | while IFS='|||' read -r msg hash; do
            clean_msg=$(echo "$msg" | sed -E 's/^[a-z_]+!?\([^)]+\)?:\s*//')
            echo "- $clean_msg (\`$hash\`)" >> $CHANGELOG_FILE
          done

          echo "" >> $CHANGELOG_FILE
        fi

        # Write output
        {
          echo "CHANGELOG<<EOF"
          cat $CHANGELOG_FILE
          echo "EOF"
        } >> $GITHUB_OUTPUT

        if [ -f "CHANGELOG.md" ]; then
          cat $CHANGELOG_FILE CHANGELOG.md > CHANGELOG_NEW.md
          mv CHANGELOG_NEW.md CHANGELOG.md
        else
          mv $CHANGELOG_FILE CHANGELOG.md
        fi

    - name: Commit CHANGELOG.md
      if: inputs.branch != 'prod' && inputs.write_file
      uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3
      with:
        branch: ${{ inputs.branch }}
        commit_message: 'chore: update CHANGELOG for ${{ inputs.tag }}'
        file_pattern: |
          CHANGELOG.md
